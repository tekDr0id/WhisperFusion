services:
  whisperfusion:
    build:
      context: docker
      dockerfile: Dockerfile
    image: whisperfusion:latest
    volumes:
      - type: bind
        source: ./docker/scratch-space
        target: /root/scratch-space
    environment:
      VERBOSE: ${VERBOSE:-false}
      MODEL: ${MODEL:-Phi-3-mini-4k-instruct}
      # Safe mode environment variables
      WF_SAFE_MODE: ${WF_SAFE_MODE:-0}      # 1 = minimal websocket server only
      WF_DISABLE_TRT: ${WF_DISABLE_TRT:-0}  # 1 = disable TensorRT, use CPU
      WF_MODE: ${WF_MODE:-full}             # websocket-only, whisper-only, full
    ports:
      - "8888:8888"
      - "6006:6006"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    entrypoint: ["/root/scratch-space/run-whisperfusion-safe.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:latest
    volumes:
      - ./docker/resources/docker/default:/etc/nginx/conf.d/default.conf:ro
      - ./examples/chatbot/html:/var/www/html:ro
      - ./docker/scripts/start-nginx.sh:/start-nginx.sh:ro
    ports:
      - "8000:80"
    depends_on:
      - whisperfusion
    entrypoint: ["/bin/bash", "/start-nginx.sh"]